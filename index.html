<!DOCTYPE html>
<html lang="es">

<head>
    
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta charset="utf-8">
    <script type="text/javascript" src="https://d3js.org/d3.v7.min.js"></script>
    <script src="sp.js"></script>

    <link rel="icon" type="image/x-icon" href="fav.ico">
    <style>
        * {
            font-family: 'Trebuchet MS', 'Lucida Sans Unicode', 'Lucida Grande', 'Lucida Sans', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: rgb(200, 200, 200);
        }

        body {
            /*< background: linear-gradient(90deg, rgb(125, 125, 255), rgb(175, 175, 255));*/
        }

        .bar {
            transition-duration: 0.2s;
        }

        .bar:hover {
            /*fill: rgba(255, 255, 255, 0.2);*/
        }

        #sas {
            /*background-color: rgb(116, 28, 230);*/
            width: min-content;
            margin: auto;
        }

        #bosque {
            /*background-color: rgb(35, 214, 214);*/
            border: 1px black solid;
            border-bottom: none;
        }

        #divbutton {
            /*background-color: rgb(125, 125, 255);*/
            padding: 10px;
        }

        form {
            /*background-color: rgb(196, 241, 104);*/
            box-sizing: content-box;
            padding: 10px;
        }

        form li {
            display: inline-block;
            list-style: none;
        }

        select {
            width: 100px;
            
        }

        .sas-div {
            display: inline-block;
            
        }

        .hide_class {
            display: none;
        }
    </style>
</head>

<body>
    <main style="margin-top: 10px;">
        <div id="sas">
            <div id="bosque">
                <div class="sas-div">
                    <form id="forma">
                        <ul>
                            <li>
                                <div>
                                    <select name="age">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </li>
                            <li>
                                <div>
                                    <select name="ciclo">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </li>
                            <li>
                                <div>
                                    <select name="examen">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </li>
                            <li>
                                <div>
                                    <select name="zona">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </li>
                            <li>
                                <div>
                                    <select name="lugar" >
                                        <option value=""></option>
                                    </select>
                                </div>
                            </li>
                        </ul>
                    </form>

                </div>
                <div class="sas-div">
                    <div id="divbutton">
                        <button id="sender">Try it</button>
                    </div>
                </div>
            </div>
            <svg id="svg_desplegador">
                
            </svg>
        </div>
    </main>

    <script>
        //const form = (document.forms)[0]; select_inf
        //const prom = new Promise()
        const form = document.getElementById('forma')
        const sender = document.getElementById('sender');
        const age_select = form[0]
        const ciclo_select = form[1]
        const examen_select = form[2]
        const zona_select = form[3]
        const lugar_select = form[4]

        const romanos = ["I", "II", "III", "IV", "V"]
        const puestos = ["1°", "2°", "3°", "4°", "5°"]

        // const select_json_url = "masmas/select.json" no seria una peticion html sino una local 
        const select_json_url = "https://protonianosaurio.github.io/select/select.json"

        const select_example = document.createElement('select')
        /*
        const rquest = new XMLHttpRequest();

        rquest.open('GET', select_json_url)
        rquest.responseType = "json"
        rquest.send()

        rquest.onload = function () {
            const respuesta = rquest.response
            var aver_si_cambia = 0

            for (i in respuesta) {
                const option = document.createElement('option')
                option.value = i
                option.textContent = i
                age_select.appendChild(option)
            }
            var age_ = ""
            var ciclo_ = ""

            age_select.addEventListener('change', function () {
                const value = age_select.value
                ciclo_select.selectedIndex = ciclo_select[0]
                hide_examen_selector()
                hide_zona_selector()
                var ciclos = Object.keys(respuesta[value]).length
                for (let i = 1; i < ciclo_select.length - 1; i++) {
                    if (i <= ciclos) {
                        //ciclo_select[i].removeAttribute("class")
                        //ciclo_select[i].classList.remove("hide_class")
                        ciclo_select[i].className = ""
                    } else {
                        //ciclo_select[i].classList.add("hide_class")
                        ciclo_select[i].className = "hide_class"
                    }
                }
                age_ = value
            })

            ciclo_select.addEventListener('change', function () {
                const value = ciclo_select.value;
                examen_select.selectedIndex = examen_select[0]
                hide_zona_selector()

                var examenes = Object.keys(respuesta[age_][value]).length
                for (let i = 1; i < examen_select.length; i++) {
                    if (i <= examenes) {
                        examen_select[i].className = ""
                    } else {
                        examen_select[i].className = "hide_class"
                    }
                }
                ciclo_ = value;
            })

            examen_select.addEventListener('change', function () {
                const value = examen_select.value;
                zona_select.selectedIndex = zona_select[0]

                var zonas = respuesta[age_][ciclo_][value].length

                for (let i = 1; i < zona_select.length; i++) {
                    if (i <= zonas) {
                        zona_select[i].className = ""
                    } else {
                        zona_select[i].className = "hide_class"
                    }
                }
            })
        }
        */

        const fetchPromise = fetch(select_json_url);
        // response es el objeto que el servidor devuelva
        
        fetchPromise.then(response => {
            if (!response.ok) {
                throw new Error(`tadadesc ${response}`)
            }
            return response.json()
        }).then(response => {
            const respuesta = response
            console.log(respuesta)
            for (i in respuesta) {
                const option = document.createElement('option')
                option.value = i
                option.textContent = i
                age_select.appendChild(option)
            }
            var age_ = ""
            var ciclo_ = ""
            var examen_ = ""
            var zona_ = ""

            age_select.addEventListener('change', function () {
                const value = age_select.value
                ciclo_select.selectedIndex = ciclo_select[0]

                if(ciclo_select.length != 1){
                    for (let i = ciclo_select.length-1; i > 0; i--) {
                        const element = ciclo_select[i];
                        element.remove()
                    }
                }

                hide_examen_selector()
                hide_zona_selector()
                hide_lugar_selector()

                var ciclos = Object.keys(respuesta[value]).length
                for (let i = 0; i < ciclos; i++) {
                    ciclo_select.appendChild(a_option("ciclo_" + romanos[i],"Ciclo "+ romanos[i]))
                }
                age_ = value
            })

            ciclo_select.addEventListener('change', function () {
                const value = ciclo_select.value;
                examen_select.selectedIndex = examen_select[0]

                exa_sele_length = examen_select.length
                if(exa_sele_length != 1){
                    for (let i = exa_sele_length - 1; i > 0; i--) {
                        const element = examen_select[i];
                        element.remove()
                    }
                }
                hide_zona_selector()
                hide_lugar_selector()

                var examenes = Object.keys(respuesta[age_][value]).length
                for (let i = 0; i < examenes; i++) {
                    examen_select.appendChild(a_option("examen_"+romanos[i], puestos[i]+" Examen"))
                }
                ciclo_ = value;
            })


            examen_select.addEventListener('change', function () {
                const value = examen_select.value;
                zona_select.selectedIndex = zona_select[0]

                zona_select_length = zona_select.length
                if(zona_select_length != 1){
                    for(let i = zona_select.length-1;i > 0; i--){
                        zona_select[i].remove()
                    }
                }

                hide_lugar_selector()

                var zonas = Object.keys(respuesta[age_][ciclo_][value]).length
                zona_select.appendChild(a_option("huamanga", "Huamanga"))
                for (let i = 1; i < zonas; i++) {
                    zona_select.appendChild(a_option("zona_"+romanos[i-1], "Zona "+romanos[i-1]))
                }
                examen_ = value
            })

            zona_select.addEventListener('change',function () {
                const value = zona_select.value
                lugar_select.selectedIndex = lugar_select[0]

                lugar_select_length = lugar_select.length;
                if(lugar_select_length != 1){
                    for(let i = lugar_select_length - 1 ; i > 0; i--){
                        lugar_select[i].remove()
                    }
                }

                lugares = respuesta[age_][ciclo_][examen_][value]
                
                for (let i = 0; i < lugares.length; i++) {
                    lugar_select.appendChild(a_option(lugares[i],lugares[i]))
                }
                
            })

        }).catch(error => {
            console.log(error)
        })

        //for(i in select_inf){
        //    let baca = document.createElement("option")
        //    baca.value = i;
        //    baca.textContent = i;
        //    form[0].appendChild(baca)
        //}

        function a_option(value, textContent) {
            const option = document.createElement('option');
            option.value = value
            option.textContent = textContent
            return option
        }

        function hide_examen_selector() {
            examen_select.selectedIndex = examen_select[0]
            for (let i = 1; i < examen_select.length; i++) {
                examen_select[i].className = "hide_class"
            }
        }
        function hide_zona_selector() {
            zona_select.selectedIndex = zona_select[0]
            for (let i = 1; i < zona_select.length; i++) {
                zona_select[i].className = "hide_class"
            }
        }
        function hide_lugar_selector() {
            lugar_select.selectedIndex = lugar_select[0]
            for (let i = 1; i < lugar_select.length; i++) {
                lugar_select[i].className = "hide_class"
            }
        }
    </script>
    <script>
        let lastSelected = ""

        const k = 40;
        const w = 16 * k;
        const h = 9 * k;
        const padding = 40;
        const escc = 5
        const svg = d3.select('#svg_desplegador')
            .attr("width", w)
            .attr("height", h)
            .style("border", "1px black solid")
            //.style("background", "rgb(125, 125, 255)")
        
        //const xScale = d3.scaleLinear()
        //                .range(padding, w - padding)
        const yScale = d3.scaleLinear()
                        
        sender.addEventListener("click", consoler)

        svg.append("g")
            .attr("id", "vaca")
        
        //svg.append("rect")
        //    .attr("stroke", "black")
        //    .attr("fill", "none")
        //    .attr("x", padding)
        //    .attr("y", padding)
        //    .attr("width", w - padding*2)
        //    .attr("height", h - padding*2)



        function consoler() {
            var selected = ""
            var sear = "https://protonianosaurio.github.io/informacion/j_sons/"
            
            let llenos = 0
            while (form[llenos + 1].value != "") {
                const value = form[llenos].value
                sear += value + "/"
                selected += value
                if (llenos == 3) {
                    llenos += 1
                    break
                    ""
                }
                llenos += 1
            }
            
            if (llenos <= 3) {
                sear += (form[llenos].value + "/" + form[llenos].value + ".json")
            } else {
                sear += (form[llenos].value.toUpperCase() + ".json")
            }

            selected += form[llenos].value
            if (lastSelected !== selected) {
                lastSelected = selected
                console.log(sear)

                const fechPromise = fetch(sear)
                fechPromise.then(response =>{
                    if(!response.ok){
                        throw new Error(response.status);
                    }
                    return response.json();
                }).then(json =>{
                    crearGrafico(svg.select("#vaca"), json)
                }).catch(error =>{
                    console.error(`Could not get products: ${error}`);
                })
            }
        }

        function crearGrafico(svg_element, jsonFile) {
            const escuelas = jsonFile['escuelas']
            let lista = Object.keys(escuelas)
            let listaDeValores = Array()
            const espacio = (w - padding * 2) / (lista.length)
            

            for (const key of lista) {
                listaDeValores.push(escuelas[key]['N_alumnos'])
            }
            
            yScale.domain([0, d3.max(listaDeValores, (d)=>d)]).range([h - padding, padding])

            

            if(svg_element.selectAll("rect")['_groups'][0].length != 0){
                svg_element.selectAll("rect").remove()
                svg_element.select("g").remove()
                //svg_element.selectAll("text").remove()
            }
            const axisLeft = d3.axisLeft(yScale)

            svg_element.append("g")
                .attr("transform", "translate("+(padding-10)+",0)")
                .call(axisLeft)

            svg_element.selectAll("rect")
                .data(listaDeValores)
                .enter()
                .append("rect")
                .attr("stroke", "rgba(0, 0, 0")
                .attr("height", (d) => h - yScale(d) - padding)
                .attr("width", (d)=> espacio - 5)
                .attr("x", (d, i)=> padding + i * (espacio))
                .attr("y", (d)=>  (yScale(d)))
                .append("title")
                .text((d,i)=>lista[i]+d)

            //svg_element.selectAll("text")
            //    .data(listaDeValores)
            //    .enter()
            //    .append("text")
            //    .attr("x", (d, i)=> padding + i * (espacio))
            //    .attr("y", (d)=> h - (d * escc + padding))
            //    .text((d,i)=>lista[i])
        }

    </script>
    <script>

        //var database = [53, 64, 98, 74, 61, 34, 39, 10, 15, 160, 5];
        //    database = acomodador(database, 0);
        //
//
        //svg.selectAll("rect")
        //    .data(database)
        //    .enter()
        //    .append("rect")
        //    .attr("class", "bar")
        //    .attr("fill", "rgba(255, 255, 255, 0.5")
        //    .attr("width", 35)
        //    .attr("height", (d) => d * 1.5)
        //    .attr("x", (d, i) => i * 40 + padding + 60)
        //    .attr("y", (d) => h - (d * 1.5 + padding))
        //    .append("title")
        //    .text((d) => d)
//
//
        //svg.selectAll("text")
        //    .data(database)
        //    .enter()
        //    .append("text")
        //    .text((d) => d)
        //    .attr("x", (d, i) => {
        //        var ds = (d + "");
        //        if (ds.length >= 3) {
        //            return i * 40 + padding + 5 + 60
        //        } else if (ds.length === 2) {
        //            return i * 40 + padding + 10 + 60
        //        } else {
        //            return i * 40 + padding + 16 + 60
        //        }
        //    })
        //    .attr("y", (d) => h - (d * 1.5 + padding) - 5)


        //svg.append("path")
        //    .attr("fill", "none")
        //    .attr("stroke", "black")
        //    .attr("stroke-width", 1.5)
        //    .attr("stroke-miterlimit", 1)
        //    .attr("d", masonte(database, h-30))
    </script>
</body>

</html>